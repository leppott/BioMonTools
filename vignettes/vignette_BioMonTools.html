<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Erik.Leppo@tetratech.com" />

<meta name="date" content="2020-07-16" />

<title>Vignette, BioMonTools</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Vignette, BioMonTools</h1>
<h4 class="author"><a href="mailto:Erik.Leppo@tetratech.com" class="email">Erik.Leppo@tetratech.com</a></h4>
<h4 class="date">2020-07-16</h4>



<!-- Data is in vignettes\data folder  -->
<div id="purpose" class="section level1">
<h1>Purpose</h1>
<p>The <code>BioMonTools</code> package was created to enable users to have a common set of tools for bioassessment and biomonitoring data.</p>
</div>
<div id="installation" class="section level1">
<h1>Installation</h1>
<p>The package is hosted on GitHub (<a href="https://github.com/leppott/BioMonTools" class="uri">https://github.com/leppott/BioMonTools</a>) and can be installed using the following lines of code. It is necessary to install the <code>devtools</code> package.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Installing the BioMonTools library (with the vignette) from GitHub</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(devtools) </a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">install_github</span>(<span class="st">&quot;leppott/BioMonTools&quot;</span>, <span class="dt">force=</span><span class="ot">TRUE</span>, <span class="dt">build_vignettes=</span><span class="ot">TRUE</span>)</a></code></pre></div>
</div>
<div id="help" class="section level1">
<h1>Help</h1>
<p>After the <code>BioMonTools</code> package has been installed running the following line of code will open the help file with links to all functions.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">help</span>(<span class="dt">package=</span><span class="st">&quot;BioMonTools&quot;</span>)</a></code></pre></div>
</div>
<div id="package-functions" class="section level1">
<h1>Package Functions</h1>
<p>The suite of functions in the <code>BioMonTools</code> package are presented below.</p>
<ul>
<li>metric.values</li>
<li>markExcluded</li>
<li>rarify</li>
</ul>
<div id="metric.values" class="section level2">
<h2>metric.values</h2>
<p>Calculate metric values from a data frame with taxa by sample with fully qualified master taxa information. All percent metric results are 0-1.</p>
<div id="data-preparation" class="section level3">
<h3>Data Preparation</h3>
<p>There are a number of required fields for the input file. If any fields are missing the user will be prompted as to which are missing and the user can decide whether to continue or quit. If the user continues, the missing fields will be added but will be filled with zero or NA (as appropriate). Any metrics based on the missing fields will not be valid.</p>
<p>Required Fields:</p>
<ul>
<li><p>SAMPLEID</p>
<ul>
<li><p>Unique sample identifier</p></li>
<li><p>Valid entries: character or number, must be unique</p></li>
</ul></li>
<li><p>TAXAID</p>
<ul>
<li><p>Unique taxa identifier</p></li>
<li><p>Valid entries: character or number, must be unique</p></li>
</ul></li>
<li><p>N_TAXA</p>
<ul>
<li><p>Number of individuals</p></li>
<li><p>Valid entries: number</p></li>
</ul></li>
<li><p>EXCLUDE</p>
<ul>
<li><p>Non-unique/non-distinct taxa are excluded from richness metric calculations but are counted in the other metrics. Appendix B of the ‘BCGcalc_README_20180919’ Word document describes the Excluded Taxa Decision Criteria that was used during BCG model calibration.</p></li>
<li><p>Valid entries: TRUE or FALSE</p></li>
<li><p>Non-unique/non-distinct taxa should be entered as “TRUE”</p></li>
</ul></li>
<li><p>NONTARGET</p>
<ul>
<li><p>Non-target taxa are not part of the intended capture list; e.g., fish, herps, water column taxa. They are excluded from all metric calculations.</p></li>
<li><p>Valid entries: TRUE or FALSE.</p></li>
<li><p>NonTarget taxa should be entered as “TRUE”</p></li>
</ul></li>
<li><p>INDEX_NAME</p>
<ul>
<li><p>Name of the BCG rules worksheet in the ‘Rules’ file (in the ‘extdata’ folder) that the R code is referencing.</p></li>
<li><p>Valid entries for the Puget Lowlands/Willamette Valley model: BCG_PacNW_v1_500ct or BCG_PacNW_v1_300ct.</p></li>
</ul></li>
<li><p>SITE_TYPE</p>
<ul>
<li><p>Select which BCG model to apply: Low (lo) gradient (&lt;1% NHD+ v2 flowline slope) or high (hi) gradient (≥ 1% NHD+ v2 flowline slope).</p></li>
<li><p>Valid entries: “hi” or “lo”.</p></li>
</ul></li>
<li><p>PHYLUM, SUBPHYLUM, CLASS, ORDER, FAMILY, SUBFAMILY, TRIBE, GENUS</p>
<ul>
<li><p>Phylogeny</p></li>
<li><p>Other phylogenetic rankings (e.g., SubOrder or SuperFamily) can be included but are not used in the current metric calculations.</p></li>
<li><p>Valid entries: text</p></li>
</ul></li>
<li><p>BCG_Attr</p>
<ul>
<li><p>BCG attribute assignments (for example, Stamp and Gerritsen 2018).</p></li>
<li><p>Valid entries: 1i, 1m, 2, 3, 4, 5, 6; if not available, leave blank or enter ‘NA’.</p></li>
</ul></li>
<li><p>FFG, HABIT, LIFE_CYCLE, TOLVAL, THERMAL_INDICATOR</p>
<ul>
<li><p>FFG</p>
<ul>
<li><p>Valid values for FFG: CG, CF, PR, SC, SH</p></li>
<li><p>Function feeding group entries.</p></li>
</ul></li>
<li><p>HABIT</p>
<ul>
<li><p>Valid values for HABIT: BU, CB, CN, SP, SW</p></li>
<li><p>Habit designations.</p></li>
</ul></li>
<li><p>LIFE_CYLCE</p>
<ul>
<li><p>Valid values for LIFE_CYCLE: UNI, SEMI, MULTI</p></li>
<li><p>Life cycle designations.</p></li>
</ul></li>
<li><p>THERMAL_INDICATOR</p>
<ul>
<li>Valid values for THERMAL_INDICATOR: COLD, COLD_COOL, COOL_WARM, WARM</li>
</ul></li>
<li><p>LONGLIVED</p>
<ul>
<li>Valid values for LONGLIVED: TRUE, FALSE</li>
</ul></li>
<li><p>NOTEWORTHY</p>
<ul>
<li>Valid values for NOTEWORTHY: TRUE, FALSE</li>
</ul></li>
<li><p>HABITAT</p>
<ul>
<li>Valid values for HABITAT: BRAC, DEPO, GENE, HEAD, RHEO, RIVE, SPEC, UNKN</li>
</ul></li>
</ul></li>
</ul>
<p>Fields that are optional can be in the output (see examples below).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="co"># Packages</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="kw">library</span>(readxl)</a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">library</span>(BioMonTools)</a>
<a class="sourceLine" id="cb3-5" title="5"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb3-6" title="6"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="co">#&gt; Attaching package: &#39;dplyr&#39;</span></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="co">#&gt; The following objects are masked from &#39;package:stats&#39;:</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="co">#&gt;     filter, lag</span></a>
<a class="sourceLine" id="cb3-11" title="11"><span class="co">#&gt; The following objects are masked from &#39;package:base&#39;:</span></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co">#&gt;     intersect, setdiff, setequal, union</span></a>
<a class="sourceLine" id="cb3-14" title="14"></a>
<a class="sourceLine" id="cb3-15" title="15"><span class="co"># Load Data</span></a>
<a class="sourceLine" id="cb3-16" title="16">df.data &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="kw">system.file</span>(<span class="st">&quot;./extdata/Data_Benthos.xlsx&quot;</span></a>
<a class="sourceLine" id="cb3-17" title="17">                                       , <span class="dt">package=</span><span class="st">&quot;BioMonTools&quot;</span>)</a>
<a class="sourceLine" id="cb3-18" title="18">                      , <span class="dt">guess_max =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb3-19" title="19"><span class="co"># Columns to keep</span></a>
<a class="sourceLine" id="cb3-20" title="20">myCols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Area_mi2&quot;</span>, <span class="st">&quot;SurfaceArea&quot;</span>, <span class="st">&quot;Density_m2&quot;</span>, <span class="st">&quot;Density_ft2&quot;</span>)</a>
<a class="sourceLine" id="cb3-21" title="21"></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="co"># Run Function</span></a>
<a class="sourceLine" id="cb3-23" title="23">df.metval &lt;-<span class="st"> </span><span class="kw">metric.values</span>(df.data, <span class="st">&quot;bugs&quot;</span>, <span class="dt">fun.cols2keep=</span>myCols)</a>
<a class="sourceLine" id="cb3-24" title="24"><span class="co">#&gt; Warning: `group_by_()` is deprecated as of dplyr 0.7.0.</span></a>
<a class="sourceLine" id="cb3-25" title="25"><span class="co">#&gt; Please use `group_by()` instead.</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="co">#&gt; See vignette(&#39;programming&#39;) for more help</span></a>
<a class="sourceLine" id="cb3-27" title="27"><span class="co">#&gt; This warning is displayed once every 8 hours.</span></a>
<a class="sourceLine" id="cb3-28" title="28"><span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span></a>
<a class="sourceLine" id="cb3-29" title="29"><span class="co"># Metrics of Interest</span></a>
<a class="sourceLine" id="cb3-30" title="30"><span class="co">## thermal indicator (_ti_)</span></a>
<a class="sourceLine" id="cb3-31" title="31"><span class="co">#names(df.metval)[grepl(&quot;_ti_&quot;, names(df.metval))]</span></a>
<a class="sourceLine" id="cb3-32" title="32">col.met2keep &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;ni_total&quot;</span>, <span class="st">&quot;nt_total&quot;</span>, <span class="st">&quot;nt_ti_c&quot;</span>, <span class="st">&quot;nt_ti_cc&quot;</span>, <span class="st">&quot;nt_ti_cw&quot;</span></a>
<a class="sourceLine" id="cb3-33" title="33">                , <span class="st">&quot;nt_ti_w&quot;</span>, <span class="st">&quot;pi_ti_c&quot;</span>, <span class="st">&quot;pi_ti_cc&quot;</span>, <span class="st">&quot;pi_ti_cw&quot;</span>, <span class="st">&quot;pi_ti_w&quot;</span></a>
<a class="sourceLine" id="cb3-34" title="34">                , <span class="st">&quot;pt_ti_c&quot;</span>, <span class="st">&quot;pt_ti_cc&quot;</span>, <span class="st">&quot;pt_ti_cw&quot;</span>, <span class="st">&quot;pt_ti_w&quot;</span>)</a>
<a class="sourceLine" id="cb3-35" title="35">col.ID &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;SAMPLEID&quot;</span>, <span class="kw">toupper</span>(myCols), <span class="st">&quot;INDEX_NAME&quot;</span>, <span class="st">&quot;INDEX_REGION&quot;</span>)</a>
<a class="sourceLine" id="cb3-36" title="36"><span class="co"># Ouput</span></a>
<a class="sourceLine" id="cb3-37" title="37">df.metval.ci &lt;-<span class="st"> </span>df.metval[, <span class="kw">c</span>(col.ID, col.met2keep)]</a>
<a class="sourceLine" id="cb3-38" title="38"><span class="co"># RMD table</span></a>
<a class="sourceLine" id="cb3-39" title="39"><span class="kw">kable</span>(<span class="kw">head</span>(df.metval.ci), <span class="dt">caption =</span> <span class="st">&quot;Metric Calculation, select metrics&quot;</span>)</a></code></pre></div>
<table>
<caption>Metric Calculation, select metrics</caption>
<thead>
<tr class="header">
<th align="left">SAMPLEID</th>
<th align="right">AREA_MI2</th>
<th align="left">SURFACEAREA</th>
<th align="left">DENSITY_M2</th>
<th align="left">DENSITY_FT2</th>
<th align="left">INDEX_NAME</th>
<th align="left">INDEX_REGION</th>
<th align="right">ni_total</th>
<th align="right">nt_total</th>
<th align="right">nt_ti_c</th>
<th align="right">nt_ti_cc</th>
<th align="right">nt_ti_cw</th>
<th align="right">nt_ti_w</th>
<th align="right">pi_ti_c</th>
<th align="right">pi_ti_cc</th>
<th align="right">pi_ti_cw</th>
<th align="right">pi_ti_w</th>
<th align="right">pt_ti_c</th>
<th align="right">pt_ti_cc</th>
<th align="right">pt_ti_cw</th>
<th align="right">pt_ti_w</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="right">44.084184</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">BCG_PacNW_v1_500ct</td>
<td align="left">LO</td>
<td align="right">590</td>
<td align="right">28</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">9</td>
<td align="right">7</td>
<td align="right">0.0000000</td>
<td align="right">40.169491</td>
<td align="right">20.677966</td>
<td align="right">11.864407</td>
<td align="right">0.000000</td>
<td align="right">3.571429</td>
<td align="right">32.142857</td>
<td align="right">25.000000</td>
</tr>
<tr class="even">
<td align="left">02087REF_Bug_2002-08-22_0</td>
<td align="right">1.791475</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">BCG_PacNW_v1_500ct</td>
<td align="left">HI</td>
<td align="right">542</td>
<td align="right">38</td>
<td align="right">2</td>
<td align="right">21</td>
<td align="right">7</td>
<td align="right">1</td>
<td align="right">3.1365314</td>
<td align="right">15.129151</td>
<td align="right">5.535055</td>
<td align="right">64.022140</td>
<td align="right">5.263158</td>
<td align="right">55.263158</td>
<td align="right">18.421053</td>
<td align="right">2.631579</td>
</tr>
<tr class="odd">
<td align="left">03013CSR_Bug_2003-07-01_0</td>
<td align="right">9.613734</td>
<td align="left">8</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">BCG_PacNW_v1_500ct</td>
<td align="left">HI</td>
<td align="right">508</td>
<td align="right">17</td>
<td align="right">0</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">4</td>
<td align="right">0.0000000</td>
<td align="right">2.952756</td>
<td align="right">10.236220</td>
<td align="right">60.039370</td>
<td align="right">0.000000</td>
<td align="right">17.647059</td>
<td align="right">11.764706</td>
<td align="right">23.529412</td>
</tr>
<tr class="even">
<td align="left">03053CSR_Bug_2003-08-14_0</td>
<td align="right">3.061723</td>
<td align="left">8</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">BCG_PacNW_v1_500ct</td>
<td align="left">HI</td>
<td align="right">573</td>
<td align="right">36</td>
<td align="right">1</td>
<td align="right">18</td>
<td align="right">6</td>
<td align="right">3</td>
<td align="right">3.3158813</td>
<td align="right">42.757417</td>
<td align="right">15.706806</td>
<td align="right">9.075044</td>
<td align="right">2.777778</td>
<td align="right">50.000000</td>
<td align="right">16.666667</td>
<td align="right">8.333333</td>
</tr>
<tr class="odd">
<td align="left">03054CSR_Bug_2003-08-18_0</td>
<td align="right">71.249741</td>
<td align="left">8</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">BCG_PacNW_v1_500ct</td>
<td align="left">LO</td>
<td align="right">558</td>
<td align="right">13</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">1</td>
<td align="right">3</td>
<td align="right">0.5376344</td>
<td align="right">6.451613</td>
<td align="right">5.376344</td>
<td align="right">74.910394</td>
<td align="right">7.692308</td>
<td align="right">23.076923</td>
<td align="right">7.692308</td>
<td align="right">23.076923</td>
</tr>
<tr class="even">
<td align="left">06012CSR_Bug_2006-09-05_0</td>
<td align="right">82.338353</td>
<td align="left">8</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="left">BCG_PacNW_v1_500ct</td>
<td align="left">HI</td>
<td align="right">545</td>
<td align="right">40</td>
<td align="right">1</td>
<td align="right">17</td>
<td align="right">11</td>
<td align="right">4</td>
<td align="right">1.1009174</td>
<td align="right">32.844037</td>
<td align="right">43.119266</td>
<td align="right">18.532110</td>
<td align="right">2.500000</td>
<td align="right">42.500000</td>
<td align="right">27.500000</td>
<td align="right">10.000000</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="markexcluded" class="section level2">
<h2>markExcluded</h2>
<p>Takes as an input data frame with Sample ID, Taxa ID, and phlogenetic name fields and returns a similar dataframe with a column for “excluded” taxa (TRUE or FALSE).</p>
<p>Excluded taxa are refered to by multiple names; ambiguous, non-distinct, and non-unique. The “excluded” name was chosen so as to be consistent with “non-target” taxa. That is, taxa marked as “TRUE” are treated as undesireables. Excluded taxa are those that are present in a sample when taxa of the same group are present in the same sample are identified finer level. That is, the parent is marked as excluded when child taxa are present in the same sample.</p>
<p>The excluded taxa are referenced in the metric values function. These taxa are removed from the taxa richness metrics. This is because these are coarser level taxa.</p>
<p>Exceptions is a 2 column data frame of synonyms or other exceptions. Column 1 is the name used in the TaxaID column the input data frame (df_samptax). Column 2 is the name used in the TaxaLevels columns of the input data frame (df_samptax). The phylogenetic columns (TaxaLevels) will be modified from Column 2 of the Exceptions data frame to match Column 1 of the Exceptions data frame. This ensures that the algorithm for markExcluded works properly. The changes will not be stored and the original names provided in the input data frame (df_samptax) will be returned in the final result. The function example below includes a practical case.</p>
<p>Taxa Levels are phylogenetic names that are to be checked. They should be listed in order from course (kingdom) to fine (species). Names not appearing in the data will be skipped.</p>
<p>The spelling of names must be consistent (including case) for this function to produce the intended output.</p>
<p>Returns a data frame of df_samptax with an additional column, ExcludedTaxa.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="co"># Packages</span></a>
<a class="sourceLine" id="cb4-2" title="2"><span class="kw">library</span>(readxl)</a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb4-4" title="4"><span class="kw">library</span>(lazyeval)</a>
<a class="sourceLine" id="cb4-5" title="5"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb4-6" title="6"></a>
<a class="sourceLine" id="cb4-7" title="7"><span class="co"># Data</span></a>
<a class="sourceLine" id="cb4-8" title="8">df_samps_bugs &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="kw">system.file</span>(<span class="st">&quot;./extdata/Data_Benthos.xlsx&quot;</span></a>
<a class="sourceLine" id="cb4-9" title="9">                                        , <span class="dt">package=</span><span class="st">&quot;BioMonTools&quot;</span>)</a>
<a class="sourceLine" id="cb4-10" title="10">                            , <span class="dt">guess_max=</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12"><span class="co"># Variables</span></a>
<a class="sourceLine" id="cb4-13" title="13">SampID     &lt;-<span class="st"> &quot;SampleID&quot;</span></a>
<a class="sourceLine" id="cb4-14" title="14">TaxaID     &lt;-<span class="st"> &quot;TaxaID&quot;</span></a>
<a class="sourceLine" id="cb4-15" title="15">TaxaCount  &lt;-<span class="st"> &quot;N_Taxa&quot;</span></a>
<a class="sourceLine" id="cb4-16" title="16">Exclude    &lt;-<span class="st"> &quot;Exclude_New&quot;</span></a>
<a class="sourceLine" id="cb4-17" title="17">TaxaLevels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Kingdom&quot;</span></a>
<a class="sourceLine" id="cb4-18" title="18">                , <span class="st">&quot;Phylum&quot;</span></a>
<a class="sourceLine" id="cb4-19" title="19">                , <span class="st">&quot;SubPhylum&quot;</span></a>
<a class="sourceLine" id="cb4-20" title="20">                , <span class="st">&quot;Class&quot;</span></a>
<a class="sourceLine" id="cb4-21" title="21">                , <span class="st">&quot;SubClass&quot;</span></a>
<a class="sourceLine" id="cb4-22" title="22">                , <span class="st">&quot;Order&quot;</span></a>
<a class="sourceLine" id="cb4-23" title="23">                , <span class="st">&quot;SubOrder&quot;</span></a>
<a class="sourceLine" id="cb4-24" title="24">                , <span class="st">&quot;SuperFamily&quot;</span></a>
<a class="sourceLine" id="cb4-25" title="25">                , <span class="st">&quot;Family&quot;</span></a>
<a class="sourceLine" id="cb4-26" title="26">                , <span class="st">&quot;SubFamily&quot;</span></a>
<a class="sourceLine" id="cb4-27" title="27">                , <span class="st">&quot;Tribe&quot;</span></a>
<a class="sourceLine" id="cb4-28" title="28">                , <span class="st">&quot;Genus&quot;</span></a>
<a class="sourceLine" id="cb4-29" title="29">                , <span class="st">&quot;SubGenus&quot;</span></a>
<a class="sourceLine" id="cb4-30" title="30">                , <span class="st">&quot;Species&quot;</span></a>
<a class="sourceLine" id="cb4-31" title="31">                , <span class="st">&quot;Variety&quot;</span>)</a>
<a class="sourceLine" id="cb4-32" title="32"><span class="co"># Taxa that should be treated as equivalent</span></a>
<a class="sourceLine" id="cb4-33" title="33">Exceptions &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;TaxaID&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;Sphaeriidae&quot;</span>), <span class="st">&quot;PhyloID&quot;</span>=<span class="kw">c</span>(<span class="st">&quot;Pisidiidae&quot;</span>))</a>
<a class="sourceLine" id="cb4-34" title="34"></a>
<a class="sourceLine" id="cb4-35" title="35"><span class="co"># Filter Data</span></a>
<a class="sourceLine" id="cb4-36" title="36"><span class="co"># df_samptax &lt;- filter(df_samps_bugs, !!as.name(SampID) == &quot;08BEA3478__2013-08-21_0&quot;)</span></a>
<a class="sourceLine" id="cb4-37" title="37"><span class="co"># df_tst_small &lt;- markExcluded(df_samptax, SampID, TaxaID, TaxaCount, TaxaLevels, Exceptions, Exclude)</span></a>
<a class="sourceLine" id="cb4-38" title="38"></a>
<a class="sourceLine" id="cb4-39" title="39"><span class="co"># EXAMPLE 1</span></a>
<a class="sourceLine" id="cb4-40" title="40">df_tst &lt;-<span class="st"> </span><span class="kw">markExcluded</span>(df_samps_bugs, <span class="dt">SampID=</span><span class="st">&quot;SampleID&quot;</span>, <span class="dt">TaxaID=</span><span class="st">&quot;TaxaID&quot;</span>, <span class="dt">TaxaCount =</span> <span class="st">&quot;N_Taxa&quot;</span></a>
<a class="sourceLine" id="cb4-41" title="41">                       , <span class="dt">Exclude=</span><span class="st">&quot;Exclude_New&quot;</span>, <span class="dt">TaxaLevels=</span>TaxaLevels, <span class="dt">Exceptions=</span>Exceptions)</a>
<a class="sourceLine" id="cb4-42" title="42"><span class="co">#&gt; *</span><span class="al">WARNING</span><span class="co">*, 3 taxa levels missing from input data frame; </span></a>
<a class="sourceLine" id="cb4-43" title="43"><span class="co">#&gt;  KINGDOM, SUBORDER, VARIETY</span></a>
<a class="sourceLine" id="cb4-44" title="44"><span class="co">#&gt; [1] &quot;Working on item (1/12); PHYLUM&quot;</span></a>
<a class="sourceLine" id="cb4-45" title="45"><span class="co">#&gt; Warning: `summarise_()` is deprecated as of dplyr 0.7.0.</span></a>
<a class="sourceLine" id="cb4-46" title="46"><span class="co">#&gt; Please use `summarise()` instead.</span></a>
<a class="sourceLine" id="cb4-47" title="47"><span class="co">#&gt; This warning is displayed once every 8 hours.</span></a>
<a class="sourceLine" id="cb4-48" title="48"><span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span></a>
<a class="sourceLine" id="cb4-49" title="49"><span class="co">#&gt; [1] &quot;Working on item (2/12); SUBPHYLUM&quot;</span></a>
<a class="sourceLine" id="cb4-50" title="50"><span class="co">#&gt; [1] &quot;Working on item (3/12); CLASS&quot;</span></a>
<a class="sourceLine" id="cb4-51" title="51"><span class="co">#&gt; [1] &quot;Working on item (4/12); SUBCLASS&quot;</span></a>
<a class="sourceLine" id="cb4-52" title="52"><span class="co">#&gt; [1] &quot;Working on item (5/12); ORDER&quot;</span></a>
<a class="sourceLine" id="cb4-53" title="53"><span class="co">#&gt; [1] &quot;Working on item (6/12); SUPERFAMILY&quot;</span></a>
<a class="sourceLine" id="cb4-54" title="54"><span class="co">#&gt; [1] &quot;Working on item (7/12); FAMILY&quot;</span></a>
<a class="sourceLine" id="cb4-55" title="55"><span class="co">#&gt; [1] &quot;Working on item (8/12); SUBFAMILY&quot;</span></a>
<a class="sourceLine" id="cb4-56" title="56"><span class="co">#&gt; [1] &quot;Working on item (9/12); TRIBE&quot;</span></a>
<a class="sourceLine" id="cb4-57" title="57"><span class="co">#&gt; [1] &quot;Working on item (10/12); GENUS&quot;</span></a>
<a class="sourceLine" id="cb4-58" title="58"><span class="co">#&gt; [1] &quot;Working on item (11/12); SUBGENUS&quot;</span></a>
<a class="sourceLine" id="cb4-59" title="59"><span class="co">#&gt; [1] &quot;Working on item (12/12); SPECIES&quot;</span></a>
<a class="sourceLine" id="cb4-60" title="60"></a>
<a class="sourceLine" id="cb4-61" title="61"><span class="co"># Compare</span></a>
<a class="sourceLine" id="cb4-62" title="62">df_compare &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(dplyr<span class="op">::</span><span class="kw">group_by</span>(df_tst, SampleID)</a>
<a class="sourceLine" id="cb4-63" title="63">                               , <span class="dt">Exclude_Import=</span><span class="kw">sum</span>(Exclude)</a>
<a class="sourceLine" id="cb4-64" title="64">                               , <span class="dt">Exclude_R=</span><span class="kw">sum</span>(Exclude_New))</a>
<a class="sourceLine" id="cb4-65" title="65"><span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span></a>
<a class="sourceLine" id="cb4-66" title="66">df_compare<span class="op">$</span>Diff &lt;-<span class="st"> </span>df_compare<span class="op">$</span>Exclude_Import <span class="op">-</span><span class="st"> </span>df_compare<span class="op">$</span>Exclude_R</a>
<a class="sourceLine" id="cb4-67" title="67"><span class="co">#</span></a>
<a class="sourceLine" id="cb4-68" title="68">tbl_diff &lt;-<span class="st"> </span><span class="kw">table</span>(df_compare<span class="op">$</span>Diff)</a>
<a class="sourceLine" id="cb4-69" title="69"><span class="co">#kable(tbl_diff)</span></a>
<a class="sourceLine" id="cb4-70" title="70"><span class="co"># sort</span></a>
<a class="sourceLine" id="cb4-71" title="71">df_compare &lt;-<span class="st"> </span>df_compare <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Diff))</a>
<a class="sourceLine" id="cb4-72" title="72"></a>
<a class="sourceLine" id="cb4-73" title="73"><span class="co"># Number with issues</span></a>
<a class="sourceLine" id="cb4-74" title="74"><span class="co">#sum(abs(df_compare$Diff))</span></a>
<a class="sourceLine" id="cb4-75" title="75"><span class="co"># total samples</span></a>
<a class="sourceLine" id="cb4-76" title="76"><span class="co">#nrow(df_compare)</span></a>
<a class="sourceLine" id="cb4-77" title="77"></a>
<a class="sourceLine" id="cb4-78" title="78"><span class="co"># confusion matrix</span></a>
<a class="sourceLine" id="cb4-79" title="79">tbl_results &lt;-<span class="st"> </span><span class="kw">table</span>(df_tst<span class="op">$</span>Exclude, df_tst<span class="op">$</span>Exclude_New, <span class="dt">useNA =</span> <span class="st">&quot;ifany&quot;</span>)</a>
<a class="sourceLine" id="cb4-80" title="80"><span class="co">#</span></a>
<a class="sourceLine" id="cb4-81" title="81"><span class="co"># Show differences</span></a>
<a class="sourceLine" id="cb4-82" title="82"><span class="kw">kable</span>(tbl_results, <span class="dt">caption=</span><span class="st">&quot;Confusion Matrix&quot;</span>)</a></code></pre></div>
<table>
<caption>Confusion Matrix</caption>
<thead>
<tr class="header">
<th></th>
<th align="right">FALSE</th>
<th align="right">TRUE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>FALSE</td>
<td align="right">24653</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>TRUE</td>
<td align="right">0</td>
<td align="right">2350</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="co"># samples with differences</span></a>
<a class="sourceLine" id="cb5-2" title="2">samp_diff &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(df_compare[df_compare[,<span class="st">&quot;Diff&quot;</span>]<span class="op">!=</span><span class="dv">0</span>, <span class="st">&quot;SampleID&quot;</span>])</a>
<a class="sourceLine" id="cb5-3" title="3"><span class="co">#&gt; Warning: The `i` argument of ``[`()` can&#39;t be a matrix as of tibble 3.0.0.</span></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="co">#&gt; Convert to a vector.</span></a>
<a class="sourceLine" id="cb5-5" title="5"><span class="co">#&gt; This warning is displayed once every 8 hours.</span></a>
<a class="sourceLine" id="cb5-6" title="6"><span class="co">#&gt; Call `lifecycle::last_warnings()` to see where this warning was generated.</span></a>
<a class="sourceLine" id="cb5-7" title="7"><span class="co"># results for only those with differences</span></a>
<a class="sourceLine" id="cb5-8" title="8">df_tst_diff &lt;-<span class="st"> </span>df_tst[df_tst[,<span class="st">&quot;SampleID&quot;</span>] <span class="op">%in%</span><span class="st"> </span>samp_diff<span class="op">$</span>SampleID, ]</a>
<a class="sourceLine" id="cb5-9" title="9"><span class="co"># add diff field</span></a>
<a class="sourceLine" id="cb5-10" title="10">df_tst_diff<span class="op">$</span>Exclude_Diff &lt;-<span class="st"> </span>df_tst_diff<span class="op">$</span>Exclude <span class="op">-</span><span class="st"> </span>df_tst_diff<span class="op">$</span>Exclude_New</a>
<a class="sourceLine" id="cb5-11" title="11"></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="co"># Classification Performance Metrics</span></a>
<a class="sourceLine" id="cb5-13" title="13">class_TP &lt;-<span class="st"> </span>tbl_results[<span class="dv">2</span>,<span class="dv">2</span>] <span class="co"># True Positive</span></a>
<a class="sourceLine" id="cb5-14" title="14">class_FN &lt;-<span class="st"> </span>tbl_results[<span class="dv">2</span>,<span class="dv">1</span>] <span class="co"># False Negative</span></a>
<a class="sourceLine" id="cb5-15" title="15">class_FP &lt;-<span class="st"> </span>tbl_results[<span class="dv">1</span>,<span class="dv">2</span>] <span class="co"># False Positive</span></a>
<a class="sourceLine" id="cb5-16" title="16">class_TN &lt;-<span class="st"> </span>tbl_results[<span class="dv">1</span>,<span class="dv">1</span>] <span class="co"># True Negative</span></a>
<a class="sourceLine" id="cb5-17" title="17">class_n &lt;-<span class="st"> </span><span class="kw">sum</span>(tbl_results)  <span class="co"># total</span></a>
<a class="sourceLine" id="cb5-18" title="18"><span class="co">#</span></a>
<a class="sourceLine" id="cb5-19" title="19"><span class="co"># sensitivity (recall); TP / (TP+FN); measure model to ID true positives</span></a>
<a class="sourceLine" id="cb5-20" title="20">class_sens &lt;-<span class="st"> </span>class_TP <span class="op">/</span><span class="st"> </span>(class_TP <span class="op">+</span><span class="st"> </span>class_FN)</a>
<a class="sourceLine" id="cb5-21" title="21"><span class="co"># precision; TP / (TP+FP); accuracy of model positives</span></a>
<a class="sourceLine" id="cb5-22" title="22">class_prec &lt;-<span class="st"> </span>class_TP <span class="op">/</span><span class="st"> </span>(class_TP <span class="op">+</span><span class="st"> </span>class_FP)</a>
<a class="sourceLine" id="cb5-23" title="23"><span class="co"># specifity; TN / (TN + FP); measure model to ID true negatives</span></a>
<a class="sourceLine" id="cb5-24" title="24">class_spec &lt;-<span class="st"> </span>class_TN  <span class="op">/</span><span class="st"> </span>(class_TN <span class="op">+</span><span class="st"> </span>class_FP)</a>
<a class="sourceLine" id="cb5-25" title="25"><span class="co"># overall accuracy; (TP + TN) / all cases; accuracy of all classifications</span></a>
<a class="sourceLine" id="cb5-26" title="26">class_acc &lt;-<span class="st"> </span>(class_TP <span class="op">+</span><span class="st"> </span>class_TN) <span class="op">/</span><span class="st"> </span>class_n</a>
<a class="sourceLine" id="cb5-27" title="27"><span class="co"># F1; 2 * (class_prec*class_sens) / (class_prec+class_sens)</span></a>
<a class="sourceLine" id="cb5-28" title="28"><span class="co">## balance of precision and recall</span></a>
<a class="sourceLine" id="cb5-29" title="29">class_F1 &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(class_prec <span class="op">*</span><span class="st"> </span>class_sens) <span class="op">/</span><span class="st"> </span>(class_prec <span class="op">+</span><span class="st"> </span>class_sens)</a>
<a class="sourceLine" id="cb5-30" title="30"><span class="co">#</span></a>
<a class="sourceLine" id="cb5-31" title="31">results_names &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Sensitivity (Recall)&quot;</span>, <span class="st">&quot;Precision&quot;</span>, <span class="st">&quot;Specificity&quot;</span>, <span class="st">&quot;OVerall Accuracy&quot;</span>, <span class="st">&quot;F1&quot;</span>)</a>
<a class="sourceLine" id="cb5-32" title="32">results_values &lt;-<span class="st"> </span><span class="kw">c</span>(class_sens, class_prec, class_spec, class_acc, class_F1)</a>
<a class="sourceLine" id="cb5-33" title="33"><span class="co">#</span></a>
<a class="sourceLine" id="cb5-34" title="34">tbl_class &lt;-<span class="st"> </span><span class="kw">data.frame</span>(results_names, results_values)</a>
<a class="sourceLine" id="cb5-35" title="35"><span class="kw">names</span>(tbl_class) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Performance Metrics&quot;</span>, <span class="st">&quot;Percent&quot;</span>)</a>
<a class="sourceLine" id="cb5-36" title="36">tbl_class<span class="op">$</span>Percent &lt;-<span class="st"> </span><span class="kw">round</span>(tbl_class<span class="op">$</span>Percent <span class="op">*</span><span class="dv">100</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-37" title="37"><span class="kw">kable</span>(tbl_class, <span class="dt">caption=</span><span class="st">&quot;Classification Performance Metrics&quot;</span>)</a></code></pre></div>
<table>
<caption>Classification Performance Metrics</caption>
<thead>
<tr class="header">
<th align="left">Performance Metrics</th>
<th align="right">Percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Sensitivity (Recall)</td>
<td align="right">100</td>
</tr>
<tr class="even">
<td align="left">Precision</td>
<td align="right">100</td>
</tr>
<tr class="odd">
<td align="left">Specificity</td>
<td align="right">100</td>
</tr>
<tr class="even">
<td align="left">OVerall Accuracy</td>
<td align="right">100</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="right">100</td>
</tr>
</tbody>
</table>
<p>The same data with no “exceptions” leaves 8 records misclassified.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Packages</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="kw">library</span>(readxl)</a>
<a class="sourceLine" id="cb6-3" title="3"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb6-4" title="4"><span class="kw">library</span>(lazyeval)</a>
<a class="sourceLine" id="cb6-5" title="5"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb6-6" title="6"></a>
<a class="sourceLine" id="cb6-7" title="7"><span class="co"># Data</span></a>
<a class="sourceLine" id="cb6-8" title="8">df_samps_bugs &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="kw">system.file</span>(<span class="st">&quot;./extdata/Data_Benthos.xlsx&quot;</span></a>
<a class="sourceLine" id="cb6-9" title="9">                                        , <span class="dt">package=</span><span class="st">&quot;BioMonTools&quot;</span>)</a>
<a class="sourceLine" id="cb6-10" title="10">                            , <span class="dt">guess_max=</span><span class="dv">10</span><span class="op">^</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="co"># Variables</span></a>
<a class="sourceLine" id="cb6-13" title="13">SampID     &lt;-<span class="st"> &quot;SampleID&quot;</span></a>
<a class="sourceLine" id="cb6-14" title="14">TaxaID     &lt;-<span class="st"> &quot;TaxaID&quot;</span></a>
<a class="sourceLine" id="cb6-15" title="15">TaxaCount  &lt;-<span class="st"> &quot;N_Taxa&quot;</span></a>
<a class="sourceLine" id="cb6-16" title="16">Exclude    &lt;-<span class="st"> &quot;Exclude_New&quot;</span></a>
<a class="sourceLine" id="cb6-17" title="17">TaxaLevels &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Kingdom&quot;</span></a>
<a class="sourceLine" id="cb6-18" title="18">                , <span class="st">&quot;Phylum&quot;</span></a>
<a class="sourceLine" id="cb6-19" title="19">                , <span class="st">&quot;SubPhylum&quot;</span></a>
<a class="sourceLine" id="cb6-20" title="20">                , <span class="st">&quot;Class&quot;</span></a>
<a class="sourceLine" id="cb6-21" title="21">                , <span class="st">&quot;SubClass&quot;</span></a>
<a class="sourceLine" id="cb6-22" title="22">                , <span class="st">&quot;Order&quot;</span></a>
<a class="sourceLine" id="cb6-23" title="23">                , <span class="st">&quot;SubOrder&quot;</span></a>
<a class="sourceLine" id="cb6-24" title="24">                , <span class="st">&quot;SuperFamily&quot;</span></a>
<a class="sourceLine" id="cb6-25" title="25">                , <span class="st">&quot;Family&quot;</span></a>
<a class="sourceLine" id="cb6-26" title="26">                , <span class="st">&quot;SubFamily&quot;</span></a>
<a class="sourceLine" id="cb6-27" title="27">                , <span class="st">&quot;Tribe&quot;</span></a>
<a class="sourceLine" id="cb6-28" title="28">                , <span class="st">&quot;Genus&quot;</span></a>
<a class="sourceLine" id="cb6-29" title="29">                , <span class="st">&quot;SubGenus&quot;</span></a>
<a class="sourceLine" id="cb6-30" title="30">                , <span class="st">&quot;Species&quot;</span></a>
<a class="sourceLine" id="cb6-31" title="31">                , <span class="st">&quot;Variety&quot;</span>)</a>
<a class="sourceLine" id="cb6-32" title="32"><span class="co"># Taxa that should be treated as equivalent</span></a>
<a class="sourceLine" id="cb6-33" title="33">Exceptions &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-34" title="34"></a>
<a class="sourceLine" id="cb6-35" title="35"><span class="co"># EXAMPLE 2</span></a>
<a class="sourceLine" id="cb6-36" title="36"><span class="co">## No Exceptions</span></a>
<a class="sourceLine" id="cb6-37" title="37"></a>
<a class="sourceLine" id="cb6-38" title="38">df_tst2 &lt;-<span class="st"> </span><span class="kw">markExcluded</span>(df_samps_bugs, <span class="dt">SampID=</span><span class="st">&quot;SampleID&quot;</span>, <span class="dt">TaxaID=</span><span class="st">&quot;TaxaID&quot;</span>, <span class="dt">TaxaCount =</span> <span class="st">&quot;N_Taxa&quot;</span></a>
<a class="sourceLine" id="cb6-39" title="39">                        , <span class="dt">Exclude=</span><span class="st">&quot;Exclude_New&quot;</span>, <span class="dt">TaxaLevels=</span>TaxaLevels, <span class="dt">Exceptions=</span><span class="ot">NA</span>)</a>
<a class="sourceLine" id="cb6-40" title="40"><span class="co">#&gt; *</span><span class="al">WARNING</span><span class="co">*, 3 taxa levels missing from input data frame; </span></a>
<a class="sourceLine" id="cb6-41" title="41"><span class="co">#&gt;  KINGDOM, SUBORDER, VARIETY</span></a>
<a class="sourceLine" id="cb6-42" title="42"><span class="co">#&gt; [1] &quot;Working on item (1/12); PHYLUM&quot;</span></a>
<a class="sourceLine" id="cb6-43" title="43"><span class="co">#&gt; [1] &quot;Working on item (2/12); SUBPHYLUM&quot;</span></a>
<a class="sourceLine" id="cb6-44" title="44"><span class="co">#&gt; [1] &quot;Working on item (3/12); CLASS&quot;</span></a>
<a class="sourceLine" id="cb6-45" title="45"><span class="co">#&gt; [1] &quot;Working on item (4/12); SUBCLASS&quot;</span></a>
<a class="sourceLine" id="cb6-46" title="46"><span class="co">#&gt; [1] &quot;Working on item (5/12); ORDER&quot;</span></a>
<a class="sourceLine" id="cb6-47" title="47"><span class="co">#&gt; [1] &quot;Working on item (6/12); SUPERFAMILY&quot;</span></a>
<a class="sourceLine" id="cb6-48" title="48"><span class="co">#&gt; [1] &quot;Working on item (7/12); FAMILY&quot;</span></a>
<a class="sourceLine" id="cb6-49" title="49"><span class="co">#&gt; [1] &quot;Working on item (8/12); SUBFAMILY&quot;</span></a>
<a class="sourceLine" id="cb6-50" title="50"><span class="co">#&gt; [1] &quot;Working on item (9/12); TRIBE&quot;</span></a>
<a class="sourceLine" id="cb6-51" title="51"><span class="co">#&gt; [1] &quot;Working on item (10/12); GENUS&quot;</span></a>
<a class="sourceLine" id="cb6-52" title="52"><span class="co">#&gt; [1] &quot;Working on item (11/12); SUBGENUS&quot;</span></a>
<a class="sourceLine" id="cb6-53" title="53"><span class="co">#&gt; [1] &quot;Working on item (12/12); SPECIES&quot;</span></a>
<a class="sourceLine" id="cb6-54" title="54"></a>
<a class="sourceLine" id="cb6-55" title="55"><span class="co"># Compare</span></a>
<a class="sourceLine" id="cb6-56" title="56">df_compare2 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">summarise</span>(dplyr<span class="op">::</span><span class="kw">group_by</span>(df_tst2, SampleID)</a>
<a class="sourceLine" id="cb6-57" title="57">                               , <span class="dt">Exclude_Import=</span><span class="kw">sum</span>(Exclude)</a>
<a class="sourceLine" id="cb6-58" title="58">                               , <span class="dt">Exclude_R=</span><span class="kw">sum</span>(Exclude_New))</a>
<a class="sourceLine" id="cb6-59" title="59"><span class="co">#&gt; `summarise()` ungrouping output (override with `.groups` argument)</span></a>
<a class="sourceLine" id="cb6-60" title="60">df_compare2<span class="op">$</span>Diff &lt;-<span class="st"> </span>df_compare2<span class="op">$</span>Exclude_Import <span class="op">-</span><span class="st"> </span>df_compare2<span class="op">$</span>Exclude_R</a>
<a class="sourceLine" id="cb6-61" title="61"><span class="co">#</span></a>
<a class="sourceLine" id="cb6-62" title="62">tbl_diff2 &lt;-<span class="st"> </span><span class="kw">table</span>(df_compare2<span class="op">$</span>Diff)</a>
<a class="sourceLine" id="cb6-63" title="63"><span class="co">#kable(tbl_diff2)</span></a>
<a class="sourceLine" id="cb6-64" title="64"><span class="co"># sort</span></a>
<a class="sourceLine" id="cb6-65" title="65">df_compare2 &lt;-<span class="st"> </span>df_compare2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">arrange</span>(<span class="kw">desc</span>(Diff))</a>
<a class="sourceLine" id="cb6-66" title="66"></a>
<a class="sourceLine" id="cb6-67" title="67"><span class="co"># Number with issues</span></a>
<a class="sourceLine" id="cb6-68" title="68"><span class="co">#sum(abs(df_compare2$Diff))</span></a>
<a class="sourceLine" id="cb6-69" title="69"><span class="co"># total samples</span></a>
<a class="sourceLine" id="cb6-70" title="70"><span class="co">#nrow(df_compare2)</span></a>
<a class="sourceLine" id="cb6-71" title="71"></a>
<a class="sourceLine" id="cb6-72" title="72"><span class="co"># confusion matrix</span></a>
<a class="sourceLine" id="cb6-73" title="73">tbl_results2 &lt;-<span class="st"> </span><span class="kw">table</span>(df_tst2<span class="op">$</span>Exclude, df_tst2<span class="op">$</span>Exclude_New, <span class="dt">useNA =</span> <span class="st">&quot;ifany&quot;</span>)</a>
<a class="sourceLine" id="cb6-74" title="74"><span class="co">#</span></a>
<a class="sourceLine" id="cb6-75" title="75"><span class="co"># Show differences</span></a>
<a class="sourceLine" id="cb6-76" title="76"><span class="kw">kable</span>(tbl_results2, <span class="dt">caption=</span><span class="st">&quot;Confusion Matrix&quot;</span>)</a></code></pre></div>
<table>
<caption>Confusion Matrix</caption>
<thead>
<tr class="header">
<th></th>
<th align="right">FALSE</th>
<th align="right">TRUE</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>FALSE</td>
<td align="right">24653</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td>TRUE</td>
<td align="right">8</td>
<td align="right">2342</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">kable</span>(df_compare2[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, ])</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">SampleID</th>
<th align="right">Exclude_Import</th>
<th align="right">Exclude_R</th>
<th align="right">Diff</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">08BEA3478__2013-08-21_0</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">08BEA3571__2014-09-03_0</td>
<td align="right">5</td>
<td align="right">4</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">08LIT2692__2012-09-10_0</td>
<td align="right">8</td>
<td align="right">7</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">08SAM0000__2012-07-11_0</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">08SAM0000__2013-07-25_0</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">09BLA0716__2014-08-14_0</td>
<td align="right">3</td>
<td align="right">2</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">95C__2012-10-02_0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">95T__2012-10-03_0</td>
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">02087REF_Bug_2002-08-22_0</td>
<td align="right">0</td>
<td align="right">0</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">kable</span>(<span class="kw">tail</span>(df_compare2))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">SampleID</th>
<th align="right">Exclude_Import</th>
<th align="right">Exclude_R</th>
<th align="right">Diff</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">WOODS298__2010-08-09_0</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">WOODS298__2013-09-03_0</td>
<td align="right">7</td>
<td align="right">7</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">Woods446__2010-08-19_0</td>
<td align="right">6</td>
<td align="right">6</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">Woodscres__2010-08-05_0</td>
<td align="right">11</td>
<td align="right">11</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">woodshand__2010-08-06_0</td>
<td align="right">12</td>
<td align="right">12</td>
<td align="right">0</td>
</tr>
<tr class="even">
<td align="left">woodshand__2013-09-03_0</td>
<td align="right">4</td>
<td align="right">4</td>
<td align="right">0</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="co"># samples with differences</span></a>
<a class="sourceLine" id="cb9-2" title="2">(samp_diff2 &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(df_compare2[df_compare2[,<span class="st">&quot;Diff&quot;</span>]<span class="op">!=</span><span class="dv">0</span>, <span class="st">&quot;SampleID&quot;</span>]))</a>
<a class="sourceLine" id="cb9-3" title="3"><span class="co">#&gt;                  SampleID</span></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="co">#&gt; 1 08BEA3478__2013-08-21_0</span></a>
<a class="sourceLine" id="cb9-5" title="5"><span class="co">#&gt; 2 08BEA3571__2014-09-03_0</span></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="co">#&gt; 3 08LIT2692__2012-09-10_0</span></a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co">#&gt; 4 08SAM0000__2012-07-11_0</span></a>
<a class="sourceLine" id="cb9-8" title="8"><span class="co">#&gt; 5 08SAM0000__2013-07-25_0</span></a>
<a class="sourceLine" id="cb9-9" title="9"><span class="co">#&gt; 6 09BLA0716__2014-08-14_0</span></a>
<a class="sourceLine" id="cb9-10" title="10"><span class="co">#&gt; 7       95C__2012-10-02_0</span></a>
<a class="sourceLine" id="cb9-11" title="11"><span class="co">#&gt; 8       95T__2012-10-03_0</span></a>
<a class="sourceLine" id="cb9-12" title="12"><span class="co"># results for only those with differences</span></a>
<a class="sourceLine" id="cb9-13" title="13">df_tst_diff2 &lt;-<span class="st"> </span><span class="kw">filter</span>(df_tst2, SampleID <span class="op">%in%</span><span class="st"> </span>samp_diff2<span class="op">$</span>SampleID)</a>
<a class="sourceLine" id="cb9-14" title="14"><span class="co"># add diff field</span></a>
<a class="sourceLine" id="cb9-15" title="15">df_tst_diff2<span class="op">$</span>Exclude_Diff &lt;-<span class="st"> </span>df_tst_diff2<span class="op">$</span>Exclude <span class="op">-</span><span class="st"> </span>df_tst_diff2<span class="op">$</span>Exclude_New</a>
<a class="sourceLine" id="cb9-16" title="16"></a>
<a class="sourceLine" id="cb9-17" title="17"><span class="co"># Classification Performance Metrics</span></a>
<a class="sourceLine" id="cb9-18" title="18">class_TP2 &lt;-<span class="st"> </span>tbl_results2[<span class="dv">2</span>,<span class="dv">2</span>] <span class="co"># True Positive</span></a>
<a class="sourceLine" id="cb9-19" title="19">class_FN2 &lt;-<span class="st"> </span>tbl_results2[<span class="dv">2</span>,<span class="dv">1</span>] <span class="co"># False Negative</span></a>
<a class="sourceLine" id="cb9-20" title="20">class_FP2 &lt;-<span class="st"> </span>tbl_results2[<span class="dv">1</span>,<span class="dv">2</span>] <span class="co"># False Positive</span></a>
<a class="sourceLine" id="cb9-21" title="21">class_TN2 &lt;-<span class="st"> </span>tbl_results2[<span class="dv">1</span>,<span class="dv">1</span>] <span class="co"># True Negative</span></a>
<a class="sourceLine" id="cb9-22" title="22">class_n2 &lt;-<span class="st"> </span><span class="kw">sum</span>(tbl_results2)  <span class="co"># total</span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="co">#</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="co"># sensitivity (recall); TP / (TP+FN); measure model to ID true positives</span></a>
<a class="sourceLine" id="cb9-25" title="25">class_sens2 &lt;-<span class="st"> </span>class_TP2 <span class="op">/</span><span class="st"> </span>(class_TP2 <span class="op">+</span><span class="st"> </span>class_FN2)</a>
<a class="sourceLine" id="cb9-26" title="26"><span class="co"># precision; TP / (TP+FP); accuracy of model positives</span></a>
<a class="sourceLine" id="cb9-27" title="27">class_prec2 &lt;-<span class="st"> </span>class_TP2 <span class="op">/</span><span class="st"> </span>(class_TP2 <span class="op">+</span><span class="st"> </span>class_FP2)</a>
<a class="sourceLine" id="cb9-28" title="28"><span class="co"># specifity; TN / (TN + FP); measure model to ID true negatives</span></a>
<a class="sourceLine" id="cb9-29" title="29">class_spec2 &lt;-<span class="st"> </span>class_TN2 <span class="op">/</span><span class="st"> </span>(class_TN2 <span class="op">+</span><span class="st"> </span>class_FP2)</a>
<a class="sourceLine" id="cb9-30" title="30"><span class="co"># overall accuracy; (TP + TN) / all cases; accuracy of all classifications</span></a>
<a class="sourceLine" id="cb9-31" title="31">class_acc2 &lt;-<span class="st"> </span>(class_TP2 <span class="op">+</span><span class="st"> </span>class_TN2) <span class="op">/</span><span class="st"> </span>class_n2</a>
<a class="sourceLine" id="cb9-32" title="32"><span class="co"># F1; 2 * (class_prec*class_sens) / (class_prec+class_sens)</span></a>
<a class="sourceLine" id="cb9-33" title="33"><span class="co">## balance of precision and recall</span></a>
<a class="sourceLine" id="cb9-34" title="34">class_F12 &lt;-<span class="st"> </span><span class="dv">2</span> <span class="op">*</span><span class="st"> </span>(class_prec2 <span class="op">*</span><span class="st"> </span>class_sens2) <span class="op">/</span><span class="st"> </span>(class_prec2 <span class="op">+</span><span class="st"> </span>class_sens2)</a>
<a class="sourceLine" id="cb9-35" title="35"><span class="co">#</span></a>
<a class="sourceLine" id="cb9-36" title="36">results_names2 &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Sensitivity (Recall)&quot;</span>, <span class="st">&quot;Precision&quot;</span>, <span class="st">&quot;Specificity&quot;</span>, <span class="st">&quot;OVerall Accuracy&quot;</span>, <span class="st">&quot;F1&quot;</span>)</a>
<a class="sourceLine" id="cb9-37" title="37">results_values2 &lt;-<span class="st"> </span><span class="kw">c</span>(class_sens2, class_prec2, class_spec2, class_acc2, class_F12)</a>
<a class="sourceLine" id="cb9-38" title="38"><span class="co">#</span></a>
<a class="sourceLine" id="cb9-39" title="39">tbl_class2 &lt;-<span class="st"> </span><span class="kw">data.frame</span>(results_names2, results_values2)</a>
<a class="sourceLine" id="cb9-40" title="40"><span class="kw">names</span>(tbl_class2) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Performance Metrics&quot;</span>, <span class="st">&quot;Percent&quot;</span>)</a>
<a class="sourceLine" id="cb9-41" title="41">tbl_class2<span class="op">$</span>Percent &lt;-<span class="st"> </span><span class="kw">round</span>(tbl_class2<span class="op">$</span>Percent <span class="op">*</span><span class="dv">100</span>, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb9-42" title="42"><span class="kw">kable</span>(tbl_class2, <span class="dt">caption=</span><span class="st">&quot;Classification Performance Metrics&quot;</span>)</a></code></pre></div>
<table>
<caption>Classification Performance Metrics</caption>
<thead>
<tr class="header">
<th align="left">Performance Metrics</th>
<th align="right">Percent</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Sensitivity (Recall)</td>
<td align="right">99.66</td>
</tr>
<tr class="even">
<td align="left">Precision</td>
<td align="right">100.00</td>
</tr>
<tr class="odd">
<td align="left">Specificity</td>
<td align="right">100.00</td>
</tr>
<tr class="even">
<td align="left">OVerall Accuracy</td>
<td align="right">99.97</td>
</tr>
<tr class="odd">
<td align="left">F1</td>
<td align="right">99.83</td>
</tr>
</tbody>
</table>
</div>
<div id="rarify" class="section level2">
<h2>rarify</h2>
<p>The rarify function subsamples count data to a fixed count per sample. It takes as an input a 3 column data frame (SampleID, TaxonID, Count) and returns a similar dataframe with revised Counts. The names of the columns does not matter as they are specified in the code. Any non-count taxa (e.g., fish in a bug sample) should be removed prior to using the <code>rarify</code> function. The function code is from USEPA Corvallis John Van Sickle’s R code for RIVPACS (v1.0, 2005-06-10) and was tweaked for the addition of a user provided seed so repeatable results can be obtained.</p>
<p>The other function inputs are subsample size (target number of organisms in each sample) and seed. The seed is given so the results can be reproduced from the same input file. If no seed is given a random seed is used. An example seed is the date of admission to the Union for each state where the data is collected (e.g., Washington is 18891111). These values can be found on Wikipedia on the right sidebar for each State.</p>
<p>If you are running the 500-count BCG model and any of your samples have more than 600 organisms (the upper limit for the model), you should randomly subsample your data to 600 (600 is +20% of the 500-count target). This is done to make richness metrics comparable across the 500-count samples. You can do this with the Rarify routine.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># Subsample to 500 organisms (from over 500 organisms) for 12 samples.</span></a>
<a class="sourceLine" id="cb10-2" title="2"></a>
<a class="sourceLine" id="cb10-3" title="3"><span class="co"># Packages</span></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb10-5" title="5"></a>
<a class="sourceLine" id="cb10-6" title="6"><span class="co"># load bio data</span></a>
<a class="sourceLine" id="cb10-7" title="7">df_biodata &lt;-<span class="st"> </span>data_bio2rarify</a>
<a class="sourceLine" id="cb10-8" title="8"><span class="co">#dim(df_biodata)</span></a>
<a class="sourceLine" id="cb10-9" title="9"><span class="co">#kable(head(df_biodata))</span></a>
<a class="sourceLine" id="cb10-10" title="10"></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co"># subsample</span></a>
<a class="sourceLine" id="cb10-12" title="12">mySize &lt;-<span class="st"> </span><span class="dv">500</span></a>
<a class="sourceLine" id="cb10-13" title="13">Seed_OR &lt;-<span class="st"> </span><span class="dv">18590214</span></a>
<a class="sourceLine" id="cb10-14" title="14">Seed_WA &lt;-<span class="st"> </span><span class="dv">18891111</span></a>
<a class="sourceLine" id="cb10-15" title="15">Seed_US &lt;-<span class="st"> </span><span class="dv">17760704</span></a>
<a class="sourceLine" id="cb10-16" title="16">bugs_mysize &lt;-<span class="st"> </span><span class="kw">rarify</span>(<span class="dt">inbug=</span>df_biodata, <span class="dt">sample.ID=</span><span class="st">&quot;SampleID&quot;</span></a>
<a class="sourceLine" id="cb10-17" title="17">                     ,<span class="dt">abund=</span><span class="st">&quot;N_Taxa&quot;</span>,<span class="dt">subsiz=</span>mySize, <span class="dt">mySeed=</span>Seed_US)</a>
<a class="sourceLine" id="cb10-18" title="18"><span class="co">#&gt; Rarify of samples complete. </span></a>
<a class="sourceLine" id="cb10-19" title="19"><span class="co">#&gt;  Number of samples =  12 </span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="co">#&gt;  Execution time (sec) =  0.0100000000000051</span></a>
<a class="sourceLine" id="cb10-21" title="21"></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="co"># view results</span></a>
<a class="sourceLine" id="cb10-23" title="23"><span class="co">#dim(bugs_mysize)</span></a>
<a class="sourceLine" id="cb10-24" title="24"><span class="co">#kable(head(bugs_mysize))</span></a>
<a class="sourceLine" id="cb10-25" title="25"></a>
<a class="sourceLine" id="cb10-26" title="26"><span class="co"># Compare pre- and post- subsample counts</span></a>
<a class="sourceLine" id="cb10-27" title="27">df_compare &lt;-<span class="st"> </span><span class="kw">merge</span>(df_biodata, bugs_mysize, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;SampleID&quot;</span>, <span class="st">&quot;TaxaID&quot;</span>)</a>
<a class="sourceLine" id="cb10-28" title="28">                    , <span class="dt">suffixes =</span> <span class="kw">c</span>(<span class="st">&quot;_Orig&quot;</span>,<span class="st">&quot;_500&quot;</span>))</a>
<a class="sourceLine" id="cb10-29" title="29">df_compare &lt;-<span class="st"> </span>df_compare[,<span class="kw">c</span>(<span class="st">&quot;SampleID&quot;</span>, <span class="st">&quot;TaxaID&quot;</span>, <span class="st">&quot;N_Taxa_Orig&quot;</span>, <span class="st">&quot;N_Taxa_500&quot;</span>)]</a>
<a class="sourceLine" id="cb10-30" title="30"><span class="kw">kable</span>(<span class="kw">head</span>(df_compare), <span class="dt">caption =</span> <span class="st">&quot;Comparison, by Sample&quot;</span>)</a></code></pre></div>
<table>
<caption>Comparison, by Sample</caption>
<thead>
<tr class="header">
<th align="left">SampleID</th>
<th align="left">TaxaID</th>
<th align="right">N_Taxa_Orig</th>
<th align="right">N_Taxa_500</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="left">Ceratopogoninae</td>
<td align="right">237</td>
<td align="right">142</td>
</tr>
<tr class="even">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="left">Cheumatopsyche</td>
<td align="right">2</td>
<td align="right">0</td>
</tr>
<tr class="odd">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="left">Chironomini</td>
<td align="right">8</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="left">Cladocera</td>
<td align="right">2</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="left">Coenagrionidae</td>
<td align="right">2</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="left">Corbicula</td>
<td align="right">2</td>
<td align="right">1</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"></a>
<a class="sourceLine" id="cb11-2" title="2"><span class="co"># compare totals</span></a>
<a class="sourceLine" id="cb11-3" title="3">tbl_totals &lt;-<span class="st"> </span><span class="kw">aggregate</span>(<span class="kw">cbind</span>(N_Taxa_Orig, N_Taxa_<span class="dv">500</span>) <span class="op">~</span><span class="st"> </span>SampleID, df_compare, sum)</a>
<a class="sourceLine" id="cb11-4" title="4"><span class="kw">kable</span>(<span class="kw">head</span>(tbl_totals), <span class="dt">caption =</span> <span class="st">&quot;Comparison, sample totals&quot;</span>)</a></code></pre></div>
<table>
<caption>Comparison, sample totals</caption>
<thead>
<tr class="header">
<th align="left">SampleID</th>
<th align="right">N_Taxa_Orig</th>
<th align="right">N_Taxa_500</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">01103CSR_Bug_2001-08-27_0</td>
<td align="right">816</td>
<td align="right">500</td>
</tr>
<tr class="even">
<td align="left">02087REF_Bug_2002-08-22_0</td>
<td align="right">542</td>
<td align="right">500</td>
</tr>
<tr class="odd">
<td align="left">03013CSR_Bug_2003-07-01_0</td>
<td align="right">508</td>
<td align="right">500</td>
</tr>
<tr class="even">
<td align="left">03053CSR_Bug_2003-08-14_0</td>
<td align="right">573</td>
<td align="right">500</td>
</tr>
<tr class="odd">
<td align="left">03054CSR_Bug_2003-08-18_0</td>
<td align="right">558</td>
<td align="right">500</td>
</tr>
<tr class="even">
<td align="left">06012CSR_Bug_2006-09-05_0</td>
<td align="right">545</td>
<td align="right">500</td>
</tr>
</tbody>
</table>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"></a>
<a class="sourceLine" id="cb12-2" title="2"><span class="co">## Not run: </span></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="co"># save the data</span></a>
<a class="sourceLine" id="cb12-4" title="4"><span class="co">#write.table(bugs_mysize, paste(&quot;bugs&quot;,mySize,&quot;txt&quot;,sep=&quot;.&quot;),sep=&quot;\t&quot;)</span></a>
<a class="sourceLine" id="cb12-5" title="5"><span class="co">## End(Not run)</span></a></code></pre></div>
<div id="flags" class="section level3">
<h3>Flags</h3>
<p>Results should be interpreted with caution if they are flagged for any of the criteria listed below. It is up to the user’s discretion as to how to handled flagged samples.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="co"># Packages</span></a>
<a class="sourceLine" id="cb13-2" title="2"><span class="kw">library</span>(readxl)</a>
<a class="sourceLine" id="cb13-3" title="3"><span class="kw">library</span>(reshape2)</a>
<a class="sourceLine" id="cb13-4" title="4"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="kw">library</span>(BioMonTools)</a>
<a class="sourceLine" id="cb13-6" title="6"></a>
<a class="sourceLine" id="cb13-7" title="7"><span class="co"># Import</span></a>
<a class="sourceLine" id="cb13-8" title="8">df.samps.bugs &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="kw">system.file</span>(<span class="st">&quot;./extdata/Data_Benthos.xlsx&quot;</span></a>
<a class="sourceLine" id="cb13-9" title="9">                                       , <span class="dt">package=</span><span class="st">&quot;BioMonTools&quot;</span>)</a>
<a class="sourceLine" id="cb13-10" title="10">                           , <span class="dt">guess_max =</span> <span class="dv">10</span><span class="op">^</span><span class="dv">6</span>)</a>
<a class="sourceLine" id="cb13-11" title="11"></a>
<a class="sourceLine" id="cb13-12" title="12"><span class="co"># Calculate Metrics</span></a>
<a class="sourceLine" id="cb13-13" title="13"><span class="co"># Extra columns to keep in results</span></a>
<a class="sourceLine" id="cb13-14" title="14">keep.cols &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Area_mi2&quot;</span>, <span class="st">&quot;SurfaceArea&quot;</span>, <span class="st">&quot;Density_m2&quot;</span>, <span class="st">&quot;Density_ft2&quot;</span>)</a>
<a class="sourceLine" id="cb13-15" title="15"><span class="co"># Run Function</span></a>
<a class="sourceLine" id="cb13-16" title="16">df.metrics &lt;-<span class="st"> </span><span class="kw">metric.values</span>(df.samps.bugs, <span class="st">&quot;bugs&quot;</span>, <span class="dt">fun.cols2keep =</span> keep.cols)</a>
<a class="sourceLine" id="cb13-17" title="17"></a>
<a class="sourceLine" id="cb13-18" title="18"><span class="co"># Flags</span></a>
<a class="sourceLine" id="cb13-19" title="19"><span class="co"># Import QC Checks</span></a>
<a class="sourceLine" id="cb13-20" title="20">df.checks &lt;-<span class="st"> </span><span class="kw">read_excel</span>(<span class="kw">system.file</span>(<span class="st">&quot;./extdata/MetricFlags.xlsx&quot;</span></a>
<a class="sourceLine" id="cb13-21" title="21">                                          , <span class="dt">package=</span><span class="st">&quot;BioMonTools&quot;</span>), <span class="dt">sheet=</span><span class="st">&quot;Flags&quot;</span>) </a>
<a class="sourceLine" id="cb13-22" title="22"><span class="co"># Run Function</span></a>
<a class="sourceLine" id="cb13-23" title="23">df.flags &lt;-<span class="st"> </span><span class="kw">qc.checks</span>(df.metrics, df.checks)</a>
<a class="sourceLine" id="cb13-24" title="24"></a>
<a class="sourceLine" id="cb13-25" title="25"><span class="co"># Change terminology; PASS/FAIL to NA/flag</span></a>
<a class="sourceLine" id="cb13-26" title="26">df.flags[,<span class="st">&quot;FLAG&quot;</span>][df.flags[,<span class="st">&quot;FLAG&quot;</span>]<span class="op">==</span><span class="st">&quot;FAIL&quot;</span>] &lt;-<span class="st"> &quot;flag&quot;</span></a>
<a class="sourceLine" id="cb13-27" title="27">df.flags[, <span class="st">&quot;FLAG&quot;</span>][df.flags[,<span class="st">&quot;FLAG&quot;</span>]<span class="op">==</span><span class="st">&quot;PASS&quot;</span>] &lt;-<span class="st"> </span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb13-28" title="28"><span class="co"># long to wide format</span></a>
<a class="sourceLine" id="cb13-29" title="29">df.flags.wide &lt;-<span class="st"> </span><span class="kw">dcast</span>(df.flags, SAMPLEID <span class="op">~</span><span class="st"> </span>CHECKNAME, <span class="dt">value.var=</span><span class="st">&quot;FLAG&quot;</span>)</a>
<a class="sourceLine" id="cb13-30" title="30"><span class="co"># Calc number of &quot;flag&quot;s by row.</span></a>
<a class="sourceLine" id="cb13-31" title="31">df.flags.wide<span class="op">$</span>NumFlags &lt;-<span class="st"> </span><span class="kw">rowSums</span>(df.flags.wide<span class="op">==</span><span class="st">&quot;flag&quot;</span>, <span class="dt">na.rm=</span><span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb13-32" title="32"><span class="co"># Rearrange columns</span></a>
<a class="sourceLine" id="cb13-33" title="33">NumCols &lt;-<span class="st"> </span><span class="kw">ncol</span>(df.flags.wide)</a>
<a class="sourceLine" id="cb13-34" title="34">df.flags.wide &lt;-<span class="st"> </span>df.flags.wide[, <span class="kw">c</span>(<span class="dv">1</span>, NumCols, <span class="dv">2</span><span class="op">:</span>(NumCols<span class="dv">-1</span>))]</a>
<a class="sourceLine" id="cb13-35" title="35"><span class="co"># View(df.flags.wide)</span></a>
<a class="sourceLine" id="cb13-36" title="36"></a>
<a class="sourceLine" id="cb13-37" title="37"><span class="co"># Summarize Results</span></a>
<a class="sourceLine" id="cb13-38" title="38"><span class="kw">kable</span>(<span class="kw">table</span>(df.flags[,<span class="st">&quot;CHECKNAME&quot;</span>], df.flags[,<span class="st">&quot;FLAG&quot;</span>], <span class="dt">useNA=</span><span class="st">&quot;ifany&quot;</span>))</a></code></pre></div>
<table>
<thead>
<tr class="header">
<th></th>
<th align="right">flag</th>
<th align="right">NA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>brackish organisms present</td>
<td align="right">7</td>
<td align="right">671</td>
</tr>
<tr class="even">
<td>catchment, Large</td>
<td align="right">0</td>
<td align="right">678</td>
</tr>
<tr class="odd">
<td>catchment, small</td>
<td align="right">158</td>
<td align="right">520</td>
</tr>
<tr class="even">
<td>individuals, dominant 02, Large</td>
<td align="right">202</td>
<td align="right">476</td>
</tr>
<tr class="odd">
<td>individuals, Large</td>
<td align="right">0</td>
<td align="right">678</td>
</tr>
<tr class="even">
<td>individuals, small</td>
<td align="right">77</td>
<td align="right">601</td>
</tr>
<tr class="odd">
<td>Low density (ft2)</td>
<td align="right">0</td>
<td align="right">678</td>
</tr>
<tr class="even">
<td>Low density (m2)</td>
<td align="right">0</td>
<td align="right">678</td>
</tr>
<tr class="odd">
<td>Ramellogammarus</td>
<td align="right">8</td>
<td align="right">670</td>
</tr>
<tr class="even">
<td>surface area, small</td>
<td align="right">112</td>
<td align="right">566</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
